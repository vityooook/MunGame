# Настройка Технического Кошелька и Управление Микротранзакциями

В этом руководстве описано, как настроить и использовать технический кошелек на блокчейне TON для безопасного перевода средств пользователям и управления микротранзакциями. Начнем с работы в **testnet** для минимизации рисков.

## 1. Начальная Настройка

### Сети TON
TON работает на двух сетях: **mainnet** и **testnet**. Начнем с **testnet** для безопасного тестирования.

### Деплой Кошелька
Создайте кошелек в **testnet** и получите его секретный ключ. Вот пример секретного ключа, который можно использовать для тесета:

```
020c8bb18fc4d6e02e3560e2c8acf4477b771d046eefabb8ee771e9c036c278faf190a892e5cc72446a5d8f5ca70977eb47dca6ad02913f7d358e57c7a93396f

wallet address = 0QBTntndDitJzeAQ2S-lUHu3nB5534-J_1V3RTetWK0etLjz
```

> **Внимание**: Этот ключ — конфиденциальная информация, храните его в безопасности. Хакеры часто нацелены на его кражу.

### Мониторинг Транзакций
Используйте **TonViewer** для отслеживания транзакций:
- [Ссылка на кошелек в TonViewer (testnet)](https://testnet.tonviewer.com/kQBTntndDitJzeAQ2S-lUHu3nB5534-J_1V3RTetWK0etOU2)

TonViewer работает как для **mainnet**, так и для **testnet**. Не пугайтесь, если у кошелька разные адреса — это особенность TON. Для получения дополнительной информации:
- [Проверка адресов TON](https://ton.org/address/)
- [Bounceable и Non-Bounceable адреса](https://docs.ton.org/learn/overviews/addresses#bounceable-vs-non-bounceable-addresses)

## 2. Управление Транзакциями

Существуют два способа отправки транзакций:

1. **Пакетные транзакции**: Позволяют выполнить несколько действий в одной транзакции, что снижает расходы.
   - [Пример пакетной транзакции](https://github.com/vityooook/MunGame/blob/main/examples-api/sendBatch.ts)
   - [Пример транзакции в TonViewer](https://testnet.tonviewer.com/transaction/a3869bd075f56b63f7e41e449a7d9b874e5dce347b330e9254e5ccaa5afea117)

2. **Одиночные транзакции**: Удобны для выполнения единичных действий, особенно на начальном этапе.
   - [Пример одиночной транзакции](https://github.com/vityooook/MunGame/blob/main/examples-api/sendTransaction.ts)
   - [Пример транзакции в TonViewer](https://testnet.tonviewer.com/transaction/860ed349bc0e67a3d9b0e9d1a7451bb8c7bee47f8f747b24334b6ad3c0b585a7)

Пакетные транзакции полезны для массовых операций (например, рассылка наград), поскольку они дешевле, чем одиночные.

### Использование TONAPI
Чтобы отправлять транзакции без разворачивания собственной ноды, используйте **TonAPI**. Получите бесплатный ключ (1 rps) на [TonAPI Console](https://tonconsole.com/tonapi/api-keys). Позднее можно перейти на платную подписку за $10 (10 rps).

Полезные ссылки:
- [Документация TonAPI Swagger](https://tonapi.io//api-v2)
- **JS-обертка для TonAPI**: `@ton-api/client` (есть небольшие ошибки, но работает стабильно).

### Обзор Кода
См. комментарии в [sendTransaction.ts](https://github.com/vityooook/MunGame/blob/main/examples-api/sendTransaction.ts). Основные шаги:

1. **Подключение Кошелька**: Строки 29-30 подключаются к кошельку и генерируют ключи.
2. **Создание Транзакции**: Строка 33 указывает получателя и сумму; строка 42 — пример отправки USDT. Если вы отправляете другой токен, обязательно свяжитесь со мной, так как могут потребоваться дополнительные настройки.
3. **Работа с Query**: Строка 58 управляет уникальным ID транзакции (матрица shift/bit). Структура query ID:
   - В матрице переменные shift и bit увеличиваются по мере роста количества транзакций.
   - Максимальные значения: `shift = 2^13`, `bit = 2^10`, что позволяет ~8,388,605 транзакций в заданном диапазоне времени.

4. **Интеграция с БД**: Храните данные по каждой транзакции в таблице (shift, bit, статус транзакции, hash).
5. **Проверка Транзакции**: После отправки проверяйте хэш транзакции через интервалы (10-5 секунд), пока она не подтвердится ([Строка 93](https://github.com/vityooook/MunGame/blob/main/examples-api/sendTransaction.ts#L93)).

> **Примечание**: Пример кода можно адаптировать по своему усмотрению, важно понимать основные принципы.

### Проверка Баланса Кошелька
Создайте простой скрипт для отслеживания баланса TON и jetton на кошельке. Одна транзакция с jetton стоит около 0.0038 TON.

## 3. Микротранзакции

На фронтенде интегрируется **Ton Connect**, где пользователь выбирает товар и формируется правильная сумма и комментарий. Бэкенд, в свою очередь, проверяет транзакции на кошельке:

- **Проверка комментария**: В транзакции есть комментарий, по которому можно отследить покупку. Пример — **Fragment**, где уникальные ID помогают отслеживать покупки звезд.
- **Проверка суммы**: Бэкенд сверяет сумму с ожидаемым значением, чтобы предотвратить мошенничество.

Пример:
- [Покупка звезд на Fragment](https://fragment.com/stars)
- [Транзакции на Fragment](https://tonviewer.com/EQCFJEP4WZ_mpdo0_kMEmsTgvrMHG7K_tWY16pQhKHwoOoy2)

## Полезные Ссылки

- [Документация по высоконагруженному кошельку](https://docs.ton.org/v3/guidelines/smart-contracts/howto/wallet#-high-load-wallet-v3)
- [TonViewer](https://tonviewer.com) (нажмите на шестеренку, чтобы переключиться между **testnet** и **mainnet**)
- [Документация TonAPI Swagger](https://tonapi.io//api-v2)
- [Проверка адресов TON](https://ton.org/address/)
