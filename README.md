
# Технический Кошелек TON: Настройка и Управление Микротранзакциями

Данное руководство подробно описывает процесс настройки технического кошелька в блокчейне TON для безопасного перевода средств пользователям и управления микротранзакциями. Мы рассмотрим настройку на **testnet** для минимизации рисков и подробно опишем каждый шаг.

## Содержание

1. [Начальная Настройка](#1-начальная-настройка)
   - [Сети TON](#сети-ton)
   - [Деплой Технического Кошелька](#деплой-технического-кошелька)
   - [Мониторинг Транзакций](#мониторинг-транзакций)
2. [Хранение Транзакций в Базе Данных](#2-хранение-транзакций-в-базе-данных)
   - [Структура Таблицы Транзакций](#структура-таблицы-транзакций)
3. [Настройка Технического Кода](#3-настройка-технического-кода)
   - [Клонирование Репозитория](#клонирование-репозитория)
   - [Установка Зависимостей](#установка-зависимостей)
   - [Деплой Технического Кошелька](#деплой-технического-кошелька-код)
4. [Детальная Документация](#4-детальная-документация)
   - [Управление Транзакциями](#управление-транзакциями)
   - [Использование TONAPI](#использование-tonapi)
   - [Проверка Баланса Кошелька](#проверка-баланса-кошелька)
   - [Микротранзакции на Фронтенде](#микротранзакции-на-фронтенде)
5. [Полезные Ссылки](#полезные-ссылки)

---

## 1. Начальная Настройка

### Сети TON

TON работает на двух сетях:

- **Mainnet**: Основная сеть для реальных транзакций.
- **Testnet**: Тестовая сеть для разработки и тестирования.

Мы начнем с **testnet** для безопасного тестирования функциональности без риска потери реальных средств.

### Деплой Технического Кошелька

**Важно**: Никогда не публикуйте секретный ключ в открытых источниках и не храните его в незашифрованном виде. Секретный ключ — это конфиденциальная информация, которая дает полный доступ к средствам на кошельке.

#### Шаги по Деплою Технического Кошелька:

1. **Клонирование Репозитория**:

   ```bash
   git clone https://github.com/vityooook/highload-wallet.git
   ```

2. **Переход в директорию проекта**:

   ```bash
   cd highload-wallet
   ```

3. **Установка всех зависимостей**:

   ```bash
   npm install
   ```

4. **Запуск команды для деплоя**:

   ```bash
   npx blueprint run
   ```

   - При запуске команды вам будет предложено выбрать сеть: `mainnet` или `testnet`. Выберите `testnet`.
   - Откройте некастодиальный кошелек (например, Tonkeeper или Tonhub) для подписи транзакции деплоя.
   - После успешного деплоя в консоли будет отображен публичный и секретный ключи. **Обязательно сохраните секретный ключ в безопасном месте**.

     **Пример вывода в консоли:**

     ```
     Public Key: <ваш публичный ключ>
     Secret Key: <ваш секретный ключ>
     ```

     **Примечание**: Секретный ключ предоставлен только в качестве примера. Никогда не делитесь своим реальным секретным ключом.

5. **Получение адреса Технического Кошелька**:

   - Если адрес технического кошелька не отобразился в консоли, вы можете найти его с помощью [TonViewer](https://testnet.tonviewer.com):
     - Перейдите на TonViewer и вставьте адрес кошелька, с которого вы выполняли деплой технического кошелька.
     - Найдите последнюю транзакцию и перейдите к ее деталям, чтобы увидеть адрес созданного технического кошелька.

### Мониторинг Транзакций

Используйте **TonViewer** для отслеживания транзакций и просмотра состояния кошелька:

- [TonViewer для Testnet](https://testnet.tonviewer.com)
- [TonViewer для Mainnet](https://tonviewer.com)

---

## 2. Хранение Транзакций в Базе Данных

Для эффективного управления транзакциями рекомендуется сохранять информацию о каждой транзакции в базе данных.

### Структура Таблицы Транзакций

Пример таблицы для хранения транзакций:

| id  | shift (BIGINT) | bit_number (BIGINT) | transaction_hash (STRING) | success (BOOLEAN) | Balance_sheet_table (STRING)                                   | created_at (TIMESTAMP) |
|-----|----------------|---------------------|---------------------------|-------------------|--------------------------------------------------------|------------------------|
| 1   | 0              | 0                   | `a1b2c3...`               | true              | `link to another db` | 2023-10-01 12:34:56    |
| 2   | 0              | 1                   | `d4e5f6...`               | false             | `link to another db` | 2023-10-01 12:35:10    |

**Пояснения к полям:**

- `id`: Уникальный идентификатор записи.
- `shift`: Параметр shift из матрицы для формирования уникального `query_id` транзакции.
- `bit_number`: Параметр bit number из матрицы.
- `transaction_hash`: Хеш транзакции.
- `success`: Статус выполнения транзакции (успешно или с ошибкой).
- `Balance_sheet_table`: Ссылка на детальную информацию о транзакции (кому и сколько).
- `created_at`: Время создания транзакции.

**Примечание**: Используйте `BIGINT` для хранения больших чисел, таких как `shift` и `bit_number`.

---

## 3. Настройка Технического Кода

### Клонирование Репозитория

Скопируйте код технического кошелька с GitHub:

```bash
git clone https://github.com/vityooook/highload-wallet.git
```

### Установка Зависимостей

Перейдите в директорию проекта и установите все необходимые зависимости:

```bash
cd highload-wallet
npm install
```

### Деплой Технического Кошелька (Код)

Запустите команду для деплоя кошелька:

```bash
npx blueprint run
```

- Выберите сеть: `mainnet` или `testnet`.
- Откройте некастодиальный кошелек и подпишите транзакцию деплоя.
- В консоли будут отображены секретный и публичный ключи. **Сохраните секретный ключ в безопасном месте**.

  **Пример вывода в консоли:**

  ```
  Public Key: <ваш публичный ключ>
  Secret Key: <ваш секретный ключ>
  ```

  **Примечание**: Если адрес технического кошелька не отображается в консоли, используйте [TonViewer](https://testnet.tonviewer.com) для его получения:

  - Вставьте адрес кошелька, с которого был выполнен деплой.
  - Найдите последнюю транзакцию и перейдите к деталям, чтобы увидеть адрес технического кошелька.

---

## 4. Детальная Документация

### Управление Транзакциями

**Два способа отправки транзакций:**

1. **Пакетные транзакции (Batch Transactions)**:

   - Позволяют выполнять несколько действий в одной транзакции.
   - Экономят средства на комиссии.
   - Используются для массовых операций (например, рассылка наград пользователям).

   **Пример использования:**

   ```typescript
   const actions: OutActionSendMsg[] = [];

   // Действие 1: Отправка Jetton
   actions.push({
     type: 'sendMsg',
     mode: SendMode.PAY_GAS_SEPARATELY,
     outMsg: internal({ /* параметры сообщения */ })
   });

   // Действие 2: Отправка TON с комментарием
   actions.push({
     type: 'sendMsg',
     mode: SendMode.PAY_GAS_SEPARATELY,
     outMsg: internal({ /* параметры сообщения */ })
   });

   // Отправка batch транзакции
   const messageHash = await wallet.sendBatch(
     walletKeyPair.secretKey,
     actions,
     subwalletId,
     query,
     timeout,
     createdAt
   );
   ```

2. **Одиночные транзакции (Single Transactions)**:

   - Подходят для выполнения единичных действий.
   - Удобны на начальном этапе или для простых операций.

   **Пример использования:**

   ```typescript
   const message = internal({
     to: recipientAddress,
     value: toNano("0.01"),
     body: beginCell()
       .storeUint(0, 32)
       .storeStringTail("Комментарий к платежу")
       .endCell()
   });

   const messageHash = await wallet.sendExternalMessage(
     walletKeyPair.secretKey,
     {
       message: message,
       mode: 3,
       query_id: queryHandler,
       createdAt: createdAt,
       subwalletId: subwalletId,
       timeout: timeout,
     }
   );
   ```

### Использование TONAPI

Для взаимодействия с блокчейном без разворачивания собственной ноды используйте **TonAPI**.

**Получение API ключа:**

- Зарегистрируйтесь на [TonAPI Console](https://tonconsole.com/tonapi/api-keys).
- Получите бесплатный API ключ с лимитом 1 запрос в секунду.
- При необходимости перейдите на платную подписку за $10 (10 запросов в секунду).

**Полезные ссылки:**

- [Документация TonAPI (Swagger)](https://tonapi.io/api-v2)
- **JS-клиент для TonAPI**: Используйте пакет `@ton-api/client`.

### Проверка Баланса Кошелька

Рекомендуется создать скрипт для отслеживания баланса TON и Jetton на техническом кошельке.

- **Стоимость одной транзакции с Jetton**: Около 0.0038 TON.
- **Мониторинг баланса** поможет избежать ситуаций, когда на кошельке недостаточно средств для выполнения транзакций.

### Микротранзакции на Фронтенде

На фронтенде можно интегрировать **Ton Connect** для взаимодействия с кошельками пользователей.

**Процесс покупки:**

1. **Пользователь выбирает товар** на вашем сайте.
2. **Формируется правильная сумма и комментарий** для платежа.
3. **Пользователь подтверждает транзакцию** через свой кошелек.
4. **Бэкенд проверяет транзакцию**:
   - Сверяет сумму платежа с ожидаемой.
   - Проверяет комментарий для идентификации покупки.
   - Убеждается в успешности транзакции.

**Пример использования комментариев:**

- **Fragment** использует уникальные ID в комментариях для отслеживания покупок звезд.
- Это помогает связывать транзакции с конкретными заказами и предотвращать мошенничество.

---

## Полезные Ссылки

- [Документация по высоконагруженному кошельку](https://docs.ton.org/v3/guidelines/smart-contracts/howto/wallet#-high-load-wallet-v3)
- [TonViewer](https://tonviewer.com) (нажмите на шестеренку, чтобы переключиться между **testnet** и **mainnet**)
- [Документация TonAPI (Swagger)](https://tonapi.io/api-v2)
- [Проверка адресов TON](https://ton.org/address/)
- [Bounceable и Non-Bounceable адреса](https://docs.ton.org/learn/overviews/addresses#bounceable-vs-non-bounceable-addresses)
- [Ton Connect](https://ton.org/docs/ton-connect/)

---

**Важно**: Всегда следуйте лучшим практикам безопасности при работе с криптовалютами. Храните секретные ключи в безопасных местах и не делитесь ими с третьими лицами.
